<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DOLang</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#2c3036;color:#e2e2e2;font-family:monospace;padding:15px}
  #output{background:#1f2226;padding:10px;height:320px;overflow:auto;margin-bottom:10px;border:1px solid #444a52}
  #codeInput{width:100%;height:220px;background:#26292e;color:#d0d8e2;padding:8px;border:1px solid #444a52;margin-bottom:8px;outline:none;resize:none}
  #inputBox{width:100%;height:70px;background:#26292e;color:#9fc0e5;padding:8px;border:1px solid #444a52;margin-bottom:10px;outline:none;resize:none}
  #drawCanvas{background:#fff;border:2px solid #444a52;margin:10px auto;display:block;cursor:crosshair;width:600px;height:300px}
  #imgPreview{border:1px dashed #444a52;background:#26292e;padding:10px;min-height:180px;margin:10px 0;text-align:center}
  #light{width:70px;height:70px;background:#0066ff;border-radius:50%;margin:15px auto;transition:0.5s ease;box-shadow:0 0 40px #0066ff;border:2px solid #555}
  button{padding:8px 18px;background:#5a7ca3;color:#fff;border:none;margin-right:8px;cursor:pointer}
  button:hover{background:#688bb6}
  .re-run-btn{background:#2ecc71}
  .re-run-btn:hover{background:#27ae60}
  .file-btn{background:#ffaa00;color:#000;font-weight:bold}
  .file-btn:hover{background:#ffbb33}
  .line{margin:3px 0}
  .cmd{color:#d0d8e2}
  .input{color:#9fc0e5}
  .out{color:#a8b9a8}
  .err{color:#ff6666}
  .help{color:#9fc0e5}
  .hidden{display:none}
  .forbid{color:#ff4444;font-weight:bold}
  .run{color:#44ff44;font-weight:bold}
  .stage{color:#f90;font-weight:bold}
  .egg{color:#ff69b4;font-weight:bold;text-shadow:0 0 5px #ff69b4}
  .time{color:#00ffff;font-weight:bold}
  .eg{color:#fdfd96;font-weight:bold;text-shadow:0 0 8px #fdfd96;letter-spacing:2px}
  .dongper{color:#00ff99;font-weight:bold;text-shadow:0 0 8px #00ff99}
</style>
</head>
<body>
<div id="output"></div>
<div id="light"></div>
<canvas id="drawCanvas"></canvas>
<!-- æç¤ºæ–‡å­—ï¼šè¾“å…¥/h@m? æŸ¥çœ‹å¸®åŠ© -->
<textarea id="codeInput" placeholder="è¾“å…¥/h@m? æŸ¥çœ‹å¸®åŠ©"></textarea>
<textarea id="inputBox" placeholder="è¾“å…¥å¯¹AIè¯´çš„è¯"></textarea>
<div id="imgPreview">Image Preview</div>
<button onclick="run()">RUN</button>
<button class="re-run-btn" onclick="reRun()">RESET</button>
<button onclick="clr()">CLEAR</button>
<button onclick="resetAll()">INIT</button>
<button class="file-btn" onclick="newFile()">SAVE</button>
<button class="file-btn" onclick="openFile()">LOAD</button>

<input type="file" id="fImg" class="hidden" accept="image/*">
<input type="file" id="fTxt" class="hidden" accept="text/*">
<input type="file" id="fAudio" class="hidden" accept="audio/*">
<script>
const o = document.getElementById('output');
const c = document.getElementById('codeInput');
const i = document.getElementById('inputBox');
const img = document.getElementById('imgPreview');
const fImg = document.getElementById('fImg');
const fTxt = document.getElementById('fTxt');
const fAudio = document.getElementById('fAudio');
const light = document.getElementById('light');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
let lines = [], p = 0, wait = false;
let vars = {}, arrs = {}, lastVal = 0;
let audioPlayer = new Audio();
let loopQueue = [];
let isDrawing = false;
let brushColor = '#000';
let brushSize = 2;
let isRun1End = false;

// æ ¸å¿ƒæ–°å¢ï¼šç›‘å¬è¾“å…¥æ¡†å›è½¦ï¼Œè¾“å…¥runè‡ªåŠ¨è¿è¡Œ
c.addEventListener('keydown', function(e) {
  if (e.key === 'Enter') {
    const val = c.value.trim();
    if (val === 'run') {
      e.preventDefault(); // é˜»æ­¢å›è½¦æ¢è¡Œ
      autoRun(); // æ‰§è¡Œè‡ªåŠ¨è¿è¡Œ
    }
  }
});

// è‡ªåŠ¨è¿è¡Œæ–¹æ³•
function autoRun() {
  clr();
  lines = c.value.split('\n').filter(line => line.trim() !== 'run'); // è¿‡æ»¤æ‰runå­—ç¬¦
  p = 0;
  loopQueue = [];
  isRun1End = false;
  step(); // å¼€å§‹æ‰§è¡Œä»£ç 
  log('âœ… è¾“å…¥runï¼Œè‡ªåŠ¨æ‰§è¡ŒæˆåŠŸï¼', 'out');
}

function log(t, cls) {
  let d = document.createElement('div');
  d.className = 'line ' + cls;
  d.textContent = t;
  o.appendChild(d);
  o.scrollTop = o.scrollHeight;
}
function clr() { 
  o.innerHTML = ''; 
  light.style.background = '#0066ff';
  light.style.boxShadow = '0 0 40px #0066ff';
}
function resetAll() {
  clr(); c.value=''; i.value=''; img.innerHTML='Image Preview';
  lines=[]; p=0; wait=false; loopQueue = [];
  vars={}; arrs={}; lastVal=0;
  audioPlayer.pause(); audioPlayer.src='';
  isDrawing = false;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  isRun1End = false;
}
function n() { 
  if(loopQueue.length > 0) {
    execLoop();
    return;
  }
  p++; step(); 
}
function calc(expr) {
  try {
    let s = expr;
    for(let k in vars) s = s.replaceAll(k, vars[k]);
    for(let k in arrs) {
      for(let idx in arrs[k]) {
        s = s.replaceAll(`${k}[${idx}]`, arrs[k][idx]);
      }
    }
    return Function('"use strict";return (' + s + ')')();
  } catch(e) {
    return null;
  }
}

function showHelp() {
  let help = [
    '=== DOLang å¸®åŠ©åˆ—è¡¨ ===',
    '/rn/g!@m      = å¯åŠ¨ç³»ç»Ÿ',
    '/h@m?         = æŸ¥çœ‹æœ¬å¸®åŠ©',
    'run           = è¾“å…¥åå›è½¦ï¼Œè‡ªåŠ¨æ‰§è¡Œä»£ç ï¼ˆæ— éœ€ç‚¹æŒ‰é’®ï¼‰',
    'run1-end      = ç¬¬ä¸€æ®µæ‰§è¡Œç»“æŸï¼ˆæš‚åœï¼‰',
    'run2-end      = ç¬¬äºŒæ®µæ‰§è¡Œç»“æŸï¼ˆç»ˆæ­¢ï¼‰',
    '/egg/dongper  = ğŸŒˆDongperå½©è›‹å¯¹è¯',
    '/eg/ğŸŒ ğŸŒŒğŸŒ«    = ğŸŒŒè§¦å‘ç‰¹æ•ˆå±•ç¤º',
    '/ig/time      = â°æŸ¥è¯¢å½“å‰æ—¶é—´',
    '/ig/draw#ç•«ç•« = âœï¸ å¼€å¯ç”»ç”»åŠŸèƒ½',
    '/ig/truf-bitch= ğŸš« è¿ç¦è¯ç®¡ç†',
    '/ig/cin-cnm   = ğŸ’¹ æ¶¦è®¡æåŠŸèƒ½',
    'dr-gt20.20    = ğŸ–Œï¸ è®¾ç½®ç”»ç¬”å¤§å°',
    'dr-sp [<circle>= âšª è®¾ç½®åœ†å½¢ç”»ç¬”',
    'loopN{cmd}    = ğŸ” å¾ªç¯æ‰§è¡ŒæŒ‡ä»¤Næ¬¡',
    '/tc/(done)    = ğŸ›‘ é€€å‡ºç¨‹åº',
    '========================'
  ];
  let idx = 0;
  let t = setInterval(()=>{
    if(idx < help.length) {
      log(help[idx], 'help');
      idx++;
    } else {
      clearInterval(t);
      n();
    }
  }, 100);
}

function newFile() {
  let blob = new Blob([c.value], {type: 'text/plain'});
  let url = URL.createObjectURL(blob);
  let a = document.createElement('a');
  a.href = url;
  a.download = 'dolang_code.txt';
  a.click();
  URL.revokeObjectURL(url);
  log('âœ… ä»£ç å·²ä¿å­˜ä¸ºdolang_code.txt', 'out');
}

function openFile() {
  fTxt.click();
  fTxt.onchange = function(e) {
    let reader = new FileReader();
    reader.onload = function(evt) {
      c.value = evt.target.result;
      log('âœ… ä»£ç å·²ä»æ–‡ä»¶åŠ è½½', 'out');
    };
    reader.readAsText(e.target.files[0]);
  };
}

function execLight(color) {
  switch(color.toLowerCase()) {
    case 'red':light.style.background='#ff0000';light.style.boxShadow='0 0 40px #ff0000';break;
    case 'green':light.style.background='#00ff44';light.style.boxShadow='0 0 40px #00ff44';break;
    case 'yellow':light.style.background='#ffff00';light.style.boxShadow='0 0 40px #ffff00';break;
    default:light.style.background='#0066ff';light.style.boxShadow='0 0 40px #0066ff';
  }
  log('Light Set: ' + color, 'out');
}

function execLoop() {
  let task = loopQueue[0];
  log(`> Loop ${task.cur}/${task.total}: ${task.cmd}`, 'cmd');
  if(task.cmd.startsWith('/ig/line ')) execLight(task.cmd.split(' ')[1]);
  else if(task.cmd.startsWith('pr*/') && task.cmd.endsWith('=')) log(task.cmd.slice(4, -1).trim(), 'out');
  else if(task.cmd === '/ig/draw#ç•«ç•«') execDraw();
  else if(task.cmd === '/egg/dongper') execEggDongper();
  else if(task.cmd === '/ig/time') execIgTime();
  else if(task.cmd === '/eg/ğŸŒ ğŸŒŒğŸŒ«') execEgEffect();
  task.cur++;
  if(task.cur > task.total) {
    loopQueue.shift();
    log(`Loop Done: ${task.total} times`, 'out');
  }
  setTimeout(n, 300);
}

function parseLoop(line) {
  let match = line.match(/^loop(\d+)\{([^}]+)\}$/);
  if(!match) return false;
  let times = parseInt(match[1]), cmdStr = match[2].trim();
  if(isNaN(times) || times < 1 || !cmdStr) {
    log('Loop Err: Use loopN{cmd} (Nâ‰¥1)', 'err');
    return false;
  }
  loopQueue.push({total: times, cur: 1, cmd: cmdStr});
  log(`Loop Init: ${times} times â†’ ${cmdStr}`, 'out');
  return true;
}

function execDraw() {
  isDrawing = !isDrawing;
  if(isDrawing) {
    log('âœ… ç”»ç”»åŠŸèƒ½å·²å¼€å¯ - ç”»å¸ƒæ‹–æ‹½ç»˜ç”»', 'out');
    ctx.strokeStyle = brushColor;ctx.lineWidth = brushSize;ctx.lineCap = 'round';
  } else {
    log('âŒ ç”»ç”»åŠŸèƒ½å·²å…³é—­', 'out');
  }
}

canvas.addEventListener('mousedown', (e) => {
  if(!isDrawing) return;
  ctx.beginPath();
  const pos = getCanvasPos(e);
  ctx.moveTo(pos.x, pos.y);
});
canvas.addEventListener('mousemove', (e) => {
  if(!isDrawing) return;
  const pos = getCanvasPos(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
});
canvas.addEventListener('mouseup', () => {if(isDrawing) ctx.closePath();});
canvas.addEventListener('mouseleave', () => {if(isDrawing) ctx.closePath();});

function getCanvasPos(e) {
  const rect = canvas.getBoundingClientRect();
  return {x: e.clientX - rect.left, y: e.clientY - rect.top};
}

function setBrushSize(cmd) {
  brushSize = parseFloat(cmd.replace('dr-gt', '')) || 2;
  ctx.lineWidth = brushSize;
  log(`ğŸ–Œï¸ ç”»ç¬”å¤§å°è®¾ä¸ºï¼š${brushSize}px`, 'out');
}

function setBrushShape(cmd) {
  if(cmd.includes('circle')) {
    ctx.lineCap = 'round';ctx.lineJoin = 'round';
    log(`ğŸŸ¢ ç”»ç¬”å½¢çŠ¶è®¾ä¸ºï¼šåœ†å½¢`, 'out');
  }
}

function forbidWordManage(cmd) {
  log(`ğŸš« è¿ç¦è¯ç®¡ç†å·²å¯åŠ¨`, 'forbid');
  if(cmd.includes('bitch.[<nigger>]')) log(`ğŸš« æ£€æµ‹åˆ°è¿ç¦è¯ï¼Œå·²æ‹¦æˆª`, 'forbid');
}

function runCalc(cmd) {
  log(`ğŸ’¹ æ¶¦è®¡æåŠŸèƒ½å·²å¯åŠ¨`, 'run');
  if(cmd.includes('cincnm,bi.ni')) log(`ğŸ’¹ æ¶¦è®¡ææ—¥å¿—å·²éšè—`, 'run');
}

function execEggDongper() {
  log('===================== ğŸŒˆeggğŸŒˆğŸŒ ğŸŒŒ2.0 =====================', 'egg');
  log('å­©å­å•Šé‚£æ”¹ä¸€ä¸‹:â–‚â–ƒâ–„â–…â–†â–‡â–ˆä¸¿å‹¹é˜åŒšå±®å·›å½³å½¡å»¾å½å›—å°¢å¤‚è™ç–‹', 'egg');
  log('(dongper:say% &talk%) | (dongper:compseggs)', 'egg');
  log('=========================================================', 'egg');
  let originalColor = light.style.backgroundColor;
  light.style.background = '#ff69b4';
  light.style.boxShadow = '0 0 20px #ff69b4';
  setTimeout(() => {
    light.style.background = originalColor;
    light.style.boxShadow = originalColor === '#0066ff' ? '0 0 40px #0066ff' : `0 0 40px ${originalColor}`;
  }, 1000);
}

function execIgTime() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const hour = String(now.getHours()).padStart(2, '0');
  const minute = String(now.getMinutes()).padStart(2, '0');
  const second = String(now.getSeconds()).padStart(2, '0');
  const timeStr = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
  log(`â° å½“å‰ç³»ç»Ÿæ—¶é—´ï¼š${timeStr}`, 'time');
}

function execEgEffect() {
  log('===================== ğŸŒ ğŸŒŒğŸŒ« ç‰¹æ•ˆå±•ç¤º =====================', 'eg');
  log('ğŸŒ ğŸŒŒğŸŒ«ğŸ†ğŸ‡ğŸğŸŒğŸŒƒğŸ™ğŸŒ„ğŸŒ…ğŸŒ†ğŸŒ‡ğŸŒ‰ğŸ›£ğŸ›¤', 'eg');
  log('ğŸ”²Dongper', 'dongper');
  log('=========================================================', 'eg');
  let originalColor = light.style.backgroundColor;
  let colors = ['#fdfd96', '#00ff99', '#9370db', '#00ffff'];
  let i = 0;
  let flash = setInterval(() => {
    light.style.background = colors[i];
    light.style.boxShadow = `0 0 30px ${colors[i]}`;
    i = (i + 1) % colors.length;
  }, 200);
  setTimeout(() => {
    clearInterval(flash);
    light.style.background = originalColor;
    light.style.boxShadow = originalColor === '#0066ff' ? '0 0 40px #0066ff' : `0 0 40px ${originalColor}`;
  }, 3000);
}

function step() {
  if(p >= lines.length) {
    log('=== Program End ===', 'out');
    return;
  }
  let l = lines[p].trim();
  if(!l) { n(); return; }
  if(parseLoop(l)) { n(); return; }
  log('> ' + l, 'cmd');

  if(l === 'run1-end') {
    log('=== â¸ï¸ RUN1æ®µæ‰§è¡Œç»“æŸï¼Œç‚¹å‡»RUNç»§ç»­æ‰§è¡ŒRUN2æ®µ ===', 'stage');
    isRun1End = true;
    return;
  }
  if(l === 'run2-end') {
    log('=== ğŸš€ RUN2æ®µæ‰§è¡Œç»“æŸï¼Œç¨‹åºå®Œå…¨ç»ˆæ­¢ ===', 'stage');
    p = lines.length;
    return;
  }

  if(l === '/eg/ğŸŒ ğŸŒŒğŸŒ«') { execEgEffect(); n(); return; }
  if(l === '/egg/dongper') { execEggDongper(); n(); return; }
  if(l === '/ig/time') { execIgTime(); n(); return; }
  if(l === '/ig/draw#ç•«ç•«') { execDraw(); n(); return; }
  if(l.startsWith('dr-gt')) { setBrushSize(l); n(); return; }
  if(l.startsWith('dr-sp [<circle>')) { setBrushShape(l); n(); return; }
  if(l.startsWith('/ig/truf-bitch') || l === 'bitch.[<nigger>]') { forbidWordManage(l); n(); return; }
  if(l.startsWith('/ig/cin-cnm') || l.includes('cincnm,bi.ni')) { runCalc(l); n(); return; }

  if(l.startsWith('AI*')) {
    let txt = l.slice(3);
    log('-ï¼š(='+txt+') <AI>', 'out');
    n(); return;
  }
  if(l === 'web ç™¾åº¦') {
    log('æ‰“å¼€ç™¾åº¦', 'out');
    window.open('https://www.baidu.com', '_blank');
    n(); return;
  }
  if(l === '/rn/g!@m' || l === 'r@m') {
    log('System Started', 'out');
    n(); return;
  }
  if(l === '/h@m?') {
    showHelp();
    return;
  }
  if(l === '/iw/Dongper(os)') {
    log('Opening GitHub...', 'out');
    window.open('https://github.com/CN-DONG/CN-DONG', '_blank');
    n(); return;
  }
  if(l === "i'1-13(os nik)") {
    log('OS Nik Ready', 'out');
    n(); return;
  }
  if(l === '<end & run os>') {
    log('=== OS Auto Run Success ===', 'out');
    n(); return;
  }
  if(l === '/tc/(done)') {
    log('Program Stopped', 'out');
    return;
  }
  if(l.startsWith('/ig/<') && l.endsWith('>')) {
    let name = l.slice(4, -1);
    log('Module loaded: ' + name, 'out');
    n(); return;
  }
  if(l.startsWith('/ig/line ')) {
    execLight(l.split(' ')[1]);
    n(); return;
  }
  if(l.startsWith('os_n?(') && l.endsWith(')')) {
    let name = l.slice(5, -1);
    log('System Name: ' + name, 'out');
    n(); return;
  }
  if(l.startsWith('os_c?(') && l.endsWith(')')) {
    let t = l.slice(5, -1);
    log('System Type: ' + t, 'out');
    n(); return;
  }
  if(l.startsWith('pr*/') && l.endsWith('=')) {
    let txt = l.slice(4, -1).trim();
    log(txt, 'out');
    n(); return;
  }
  if(l.startsWith('i*p/')) {
    let tip = l.slice(4);
    log('Input: ' + tip, 'input');
    wait = true;
    n(); return;
  }
  if(l.startsWith('dc_(') && l.endsWith(')')) {
    let msg = l.slice(4, -1);
    log('Confirm: ' + msg, 'input');
    wait = true;
    n(); return;
  }
  if(l === '/j*open-ph*') {
    log('Select image', 'out');
    fImg.click();
    fImg.onchange = e=>{
      if(!e.target.files[0]) return;
      let r = new FileReader();
      r.onload = ev=>{
        img.innerHTML = `<img src="${ev.target.result}" style="max-width:100%;max-height:180px">`;
      };
      r.readAsDataURL(e.target.files[0]);
    };
    n(); return;
  }
  if(l === 'j*open-wf*') {
    log('Select text', 'out');
    fTxt.click();
    fTxt.onchange = e=>{
      if(!e.target.files[0]) return;
      let r = new FileReader();
      r.onload = ev=>{ i.value = ev.target.result; };
      r.readAsText(e.target.files[0]);
    };
    n(); return;
  }
  if(l === 'SPR#') {
    log('Select audio', 'out');
    fAudio.onchange = e=>{
      if(!e.target.files[0]) return;
      audioPlayer.src = URL.createObjectURL(e.target.files[0]);
      audioPlayer.play().then(()=>log('Audio playing','out')).catch(()=>log('Audio err','err'));
    };
    fAudio.click();
    n(); return;
  }
  if(/^[A-Za-z]+\=/.test(l) && !/\[.*\]/.test(l)) {
    let [name, val] = l.split('=');
    let res = calc(val);
    if(res != null) {
      vars[name] = res; lastVal = res;
      log(name+'='+res, 'out');
    } else log('Var Err', 'err');
    n(); return;
  }
  if(/^[A-Za-z]+\[.*\]\=/.test(l)) {
    let [left, val] = l.split('=');
    let an = left.match(/^([A-Za-z]+)\[/)?.[1];
    let idx = left.match(/\[(\d+)\]/)?.[1];
    if(an && idx != null) {
      let res = calc(val);
      if(res != null) {
        if(!arrs[an]) arrs[an] = {};
        arrs[an][idx] = res; lastVal = res;
        log(left+'='+res, 'out');
      } else log('Arr Err', 'err');
    } else log('Arr Err', 'err');
    n(); return;
  }
  if(/[0-9A-Za-z\+\-\*\/\(\)]/.test(l) && !l.includes('=')) {
    let res = calc(l);
    if(res != null) { lastVal = res; log(res+'', 'out'); }
    else log('Calc Err', 'err');
    n(); return;
  }
  if(l === 'auto') { log('last='+lastVal, 'out'); n(); return; }
  log('OK', 'out');
  n();
}

// åŸæœ‰RUNæŒ‰é’®åŠŸèƒ½ä¿ç•™ï¼ˆå¤‡ç”¨ï¼‰
function run() {
  let u = i.value.trim();
  if(u) {
    log('[You] '+u, 'input');
    log('-ï¼š(='+u+') <AI>', 'out');
    i.value = '';
    return;
  }
  if(wait) { wait = false; n(); return; }
  if(isRun1End) {
    log('=== â–¶ï¸  ç»§ç»­æ‰§è¡ŒRUN2æ®µ ===', 'stage');
    isRun1End = false;
    n();
    return;
  }
  if(p === 0) { 
    clr(); 
    lines = c.value.split('\n'); 
    loopQueue = [];
  }
  step();
}

function reRun() {
  p = 0;
  loopQueue = [];
  isRun1End = false;
  clr();
  lines = c.value.split('\n');
  step();
}
</script>
</body>
</html>
